name: WordPress.org Plugin Attestation
description: Generates an attestation for the build provenance of a plugin published on WordPress.org
author: johnbillion
branding:
  icon: check-circle
  color: green

inputs:
  plugin:
    description: The plugin slug
    required: true
    type: string
  version:
    description: The version number of the release
    required: true
    type: string
  zip-path:
    description: The path to the plugin zip file
    required: true
    type: string
  timeout:
    description: The maximum time in minutes to wait for the plugin zip to become available on WordPress.org
    required: false
    type: number
    default: 60
  dry-run:
    description: Set this to true to skip generating the actual attestation
    required: false
    type: boolean
    default: false

runs:
  using: composite
  steps:
    # This fetches the zipped plugin from w.org. The zip might not exist yet if the plugin uses release confirmation
    # and the release hasn't been confirmed. This will retry until the zip is available or the timeout is reached.
    - name: Fetch ZIP from WordPress.org
      run: ./bin/fetch-zip.sh ${{ inputs.plugin }} ${{ inputs.version }} ${{ inputs.timeout }}
      shell: bash

    # Now compare the contents of the generated zip and the w.org zip to ensure they match. Only then can we attest the w.org zip.
    - name: Unzip ${{ inputs.plugin }}.zip from WordPress.org
      run: | #shell
        unzip "${{ inputs.plugin }}.zip" -q -d zip-org
      shell: bash

    - name: Unzip the generated zip
      run: | #shell
        unzip "${{ inputs.zip-path }}" -q -d zip-generated
      shell: bash

    - name: Ensure the directories are identical
      run: | #shell
        diff -r zip-generated zip-org
      shell: bash

    - name: Generate attestation for the plugin
      if: ${{ ! inputs.dry-run }}
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: "${{ github.workspace }}/${{ inputs.plugin }}.zip"
        subject-name: "wordpress.org-${{ inputs.plugin }}-${{ inputs.version }}"

    - name: Check the attestation
      if: ${{ ! inputs.dry-run }}
      run: | #shell
        gh attestation verify "${{ inputs.plugin }}.zip" --repo "${{ github.repository }}"
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
